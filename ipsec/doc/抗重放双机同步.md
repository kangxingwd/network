# 主备切换时更新防重放参数的方法
https://patents.google.com/patent/CN101917294B/zh

## 抗重放 
- RFC 4301 4.4.2.  1
- RFC 6027
- RFC 6311

- IPSec协议的防重放功能主要涉及两个参数：防重放序号（kquence Number Counter)和防重放窗口（Anti-R印lay Window)。其中，防重放序号用于发送IPsec报文时， 填入报文头。防重放序号从1开始递增，每个IPSec报文防重放序号不同。根据RFC 4301 4.4.2. 1.的定义，如图1所示，防重放窗口为一个64位的比特位图，用于接收IPSec报文并判断IPSec报文是否为重放报文。收到一个特定防重放序号的IPSec报文时，设备将防重放窗口中相关的比特位置位为1，如果后续再收到一个相同防重放序号的报文，查看防重放窗口中相关比特位，由于比特位已置位为1，说明这个报文之前已收到过，设备获知该报文是一个重放报文，将进行防重放处理。如果接收到的IPSec报文的防重放序号在防重放窗口右边界之外，则防重放窗口右边界滑动到最新的防重放序号处。如果接收到IPSec报文的防重放序号在防重放窗口左边界之外，表明出现报文乱序的情况，同时也说明这样的报文在网络上传输时间很长，有被篡改的危险，因此这样的报文也会被丢弃

- IPSec协议的防重放功能被广泛采用，包括应用于双机热备。IPSec协议在双机热备中的应用分为两种方式：主备方式和负载分担方式。主备方式是指双机中一台设备作为主用设备，一台作为备用设备，只有主用设备才能处理IPSec数据流量，当主用设备出现故障时，备用设备升级为主设备，替代原有主用设备进行工作。另外一种方式为负载分担方式，双机均可处理IPSec数据流量。对于主备方式，IPSec协议需要在双机之间同步IPkc SA信息。主设备IPkc SA生成后，需要将IPkc SA同步到备用设备。IPkc SA处理数据流量时，防重放窗口和防重放序号会实时更新，这两个参数均需及时同步到备用设备上，以便备用设备升级为主设备时能正常工作。如果防重放窗口同步不及时，会造成主备切换后需要新主用设备处理的IPSec报文无法正确判断是否为重放报文，影响其安全性；如果防重放序号同步不及时，会导致主备切换后新主用设备加封装的IPSec报文填入在分支设备上看来在已经在防重放窗口左侧的序号，导致IPSec报文可能被丢弃，导致数据转发中断。

- 为了实现IPSec双机热备中同步防重放窗口和防重放序号，现有技术中提供一种同步防重放窗口和防重放序号的方式，即主用设备每更新一次窗口和序号就向备用设备进行同步，但是每个报文都需要进行同步的机制对于IPSec转发性能影响巨大，对于双机热备通道的压力也很大，因此现有技术中对该方式进行改进，定时（例如每隔0.5秒）或是每隔固定报文数（例如每隔10000隔报文）进行同步，缓解备份压力。

- 为了避免在同步周期之间发生主备切换导致防重放序号还停留在上一次同步值的情况，在主备切换后，新主设备IPkc SA的防重放序号主动累加一个频率值（如10000)， 防重放窗口由于无法主动累加，因此数值等于上一次同步值，进入新主设备的IPSec报文会更新防重放窗口。


### 杭州华三通信技术有限公司 1
- https://patents.google.com/patent/CN101917294B/zh
- 主备机不同步 序列号相关信息
- 主备发生切换后， 设置本段sa 禁用状态， 然后发送 查询序列号和窗口的通知请求，对端回应后，根据对端回的 序列号和窗口信息更新本段的信息； 之后启用sa；
- 涉及非标准的查询报文；（自定义的报文， 第三方不支持）


### 杭州华三通信技术有限公司 2
    https://patents.google.com/patent/CN101577725A/zh

    主备切换前, 主机记录主备切换前出站SA的防重放序号、入站SA的防重放窗口的初始值和出站SA在设定时间内处理报文数的最大值。 定期同步；
    切换后， 出站的防重放序列号=切换前同步的序列号+设定时间内处理报文的最大数值；
    并将该防重放序号以通知载荷消息发送到对端设备更新序列号；


### 成都卫士通信息产业股份有限公司
- https://patents.google.com/patent/CN108322330B/zh
- 在IKE-ISAKMP通知载荷增加四个消息类型，用于序列号重置通知及确认、抗重放窗口重置通知及确认：
    - 序列号重置消息：SEQUENCE_NOTIFICATION，序列号确认消息：SEQUENCE_CONFIRMATION，抗重放窗口重置消息：WINDOW_NOTIFICATION，抗重放窗口确认消息：WINDOW_ CONFIRMATION

